- trigger:
    - platform: time_pattern
      minutes: "/10"
      id: "time"
  action:
    - variables:
        # Get the current time, subtract 10 minutes, round to nearest 10 minutes:
        # e.g.
        # 22:19:59 -> 22:09:59 -> 22:10:00
        # 22:20:05 -> 22:10:05 -> 22:10:00
        # The trigger has a margin of 5 minutes to fire to ensure that the
        # service will request the KNMI temperature of 10 minutes before that.
        date_var: >
          {% set date_val = trigger.now %}
          {% set date_val_ts = date_val | as_timestamp %}
          {% set prev_date_val_ts = ((date_val_ts - 10*60) / (10*60)) | round(0) * 10*60 %}
          {% set prev_date_val = prev_date_val_ts | as_datetime | as_local %}
          {{ prev_date_val }}
        parameter_temp_var: "ta"
        parameter_wind_var: "ff"
        parameter_irr_var: "qg"
        location_1_name: !secret knmi_location_1_name
        location_2_name: !secret knmi_location_2_name
        location_3_name: !secret knmi_location_3_name
        location_4_name: !secret knmi_location_4_name
        location_1_id: !secret knmi_location_1_id
        location_2_id: !secret knmi_location_2_id
        location_3_id: !secret knmi_location_3_id
        location_4_id: !secret knmi_location_4_id
    - service: rest_command.get_knmi_edr_observations_location_data
      data:
        location_id: "0-20000-0-{{ location_1_id }},0-20000-0-{{ location_2_id }},0-20000-0-{{ location_3_id }},0-20000-0-{{ location_4_id }}"
        date_interval: "{{ date_var }}"
        parameter_name: "{{ parameter_temp_var }},{{ parameter_wind_var }},{{ parameter_irr_var }}"
      response_variable: location_data
    - variables:
        valid: "{{ location_data['status'] == 200 }}"
        data: >
          {{ iif(
              valid | bool, 
              location_data['content'], 
              '{"coverages": [
                { "ranges": {
                    "ff": { "values": [0] },
                    "qg": { "values": [0] },
                    "ta": { "values": [0] }
                  }
                },{ "ranges": {
                    "ff": { "values": [0] },
                    "qg": { "values": [0] },
                    "ta": { "values": [0] }
                  }
                },{ "ranges": {
                    "ff": { "values": [0] },
                    "qg": { "values": [0] },
                    "ta": { "values": [0] }
                  }
                },{ "ranges": {
                    "ff": { "values": [0] },
                    "qg": { "values": [0] },
                    "ta": { "values": [0] }
                  }
                }
              ]}' | from_json
            )
          }}
        location_1_data: "{{ data['coverages'][0]['ranges'] }}"
        location_2_data: "{{ data['coverages'][1]['ranges'] }}"
        location_3_data: "{{ data['coverages'][2]['ranges'] }}"
        location_4_data: "{{ data['coverages'][3]['ranges'] }}"
        location_1_temp: "{{ location_1_data[parameter_temp_var]['values'][0] }}"
        location_2_temp: "{{ location_2_data[parameter_temp_var]['values'][0] }}"
        location_3_temp: "{{ location_3_data[parameter_temp_var]['values'][0] }}"
        location_4_temp: "{{ location_4_data[parameter_temp_var]['values'][0] }}"
        location_1_wind: "{{ location_1_data[parameter_wind_var]['values'][0] }}"
        location_2_wind: "{{ location_2_data[parameter_wind_var]['values'][0] }}"
        location_3_wind: "{{ location_3_data[parameter_wind_var]['values'][0] }}"
        location_4_wind: "{{ location_4_data[parameter_wind_var]['values'][0] }}"
        location_1_irr: "{{ location_1_data[parameter_irr_var]['values'][0] }}"
        location_2_irr: "{{ location_2_data[parameter_irr_var]['values'][0] }}"
        location_3_irr: "{{ location_3_data[parameter_irr_var]['values'][0] }}"
        location_4_irr: "{{ location_4_data[parameter_irr_var]['values'][0] }}"
  sensor:
    - unique_id: location_1_knmi_temperature
      name: "{{ location_1_name }} KNMI Temperature"
      availability: "{{ valid | bool }}"
      state: "{{ location_1_temp }}"
      state_class: measurement
      device_class: temperature
      unit_of_measurement: °C
    - unique_id: location_2_knmi_temperature
      name: "{{ location_2_name }} KNMI Temperature"
      availability: "{{ valid | bool }}"
      state: "{{ location_2_temp }}"
      state_class: measurement
      device_class: temperature
      unit_of_measurement: °C
    - unique_id: location_3_knmi_temperature
      name: "{{ location_3_name }} KNMI Temperature"
      availability: "{{ valid | bool }}"
      state: "{{ location_3_temp }}"
      state_class: measurement
      device_class: temperature
      unit_of_measurement: °C
    - unique_id: location_4_knmi_temperature
      name: "{{ location_4_name }} KNMI Temperature"
      availability: "{{ valid | bool }}"
      state: "{{ location_4_temp }}"
      state_class: measurement
      device_class: temperature
      unit_of_measurement: °C

    - unique_id: location_1_knmi_wind_speed
      name: "{{ location_1_name }} KNMI Wind Speed"
      availability: "{{ valid | bool }}"
      state: "{{ location_1_wind }}"
      state_class: measurement
      device_class: speed
      unit_of_measurement: m/s
    - unique_id: location_2_knmi_wind_speed
      name: "{{ location_2_name }} KNMI Wind Speed"
      availability: "{{ valid | bool }}"
      state: "{{ location_2_wind }}"
      state_class: measurement
      device_class: speed
      unit_of_measurement: m/s
    - unique_id: location_3_knmi_wind_speed
      name: "{{ location_3_name }} KNMI Wind Speed"
      availability: "{{ valid | bool }}"
      state: "{{ location_3_wind }}"
      state_class: measurement
      device_class: speed
      unit_of_measurement: m/s
    - unique_id: location_4_knmi_wind_speed
      name: "{{ location_4_name }} KNMI Wind Speed"
      availability: "{{ valid | bool }}"
      state: "{{ location_4_wind }}"
      state_class: measurement
      device_class: speed
      unit_of_measurement: m/s

    - unique_id: location_1_knmi_solar_irradiance
      name: "{{ location_1_name }} KNMI Solar Irradiance"
      availability: "{{ valid | bool }}"
      state: "{{ location_1_irr }}"
      state_class: measurement
      device_class: irradiance
      unit_of_measurement: W/m²
    - unique_id: location_2_knmi_solar_irradiance
      name: "{{ location_2_name }} KNMI Solar Irradiance"
      availability: "{{ valid | bool }}"
      state: "{{ location_2_irr }}"
      state_class: measurement
      device_class: irradiance
      unit_of_measurement: W/m²
    - unique_id: location_3_knmi_solar_irradiance
      name: "{{ location_3_name }} KNMI Solar Irradiance"
      availability: "{{ valid | bool }}"
      state: "{{ location_3_irr }}"
      state_class: measurement
      device_class: irradiance
      unit_of_measurement: W/m²
    - unique_id: location_4_knmi_solar_irradiance
      name: "{{ location_4_name }} KNMI Solar Irradiance"
      availability: "{{ valid | bool }}"
      state: "{{ location_4_irr }}"
      state_class: measurement
      device_class: irradiance
      unit_of_measurement: W/m²
