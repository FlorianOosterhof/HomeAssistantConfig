- trigger:
    - platform: state
      entity_id: sensor.dhw_flame_time_ratio
      attribute: is_final
      id: "gas"
  sensor:
    - unique_id: gas_consumed_dhw
      name: Gas consumed for DHW
      device_class: gas
      state_class: total_increasing
      unit_of_measurement: m³
      state: >
        {% if trigger.to_state.attributes.is_final == 'true' %}
          {{ this.state | float + (trigger.to_state.state | float) * (trigger.to_state.attributes.gas_incr | float) }}
        {% else %}
          {{ this.state }}
        {% endif %}
      attributes:
        is_final: "{{ trigger.to_state.attributes.is_final }}"

- trigger:
    - platform: state
      entity_id: sensor.gas_consumed_for_dhw
  sensor:
    - unique_id: gas_consumed_ch
      name: Gas consumed for CH
      device_class: gas
      state_class: total_increasing
      unit_of_measurement: m³
      state: "{{ states('sensor.gas_consumed') | float - trigger.to_state.state | float }}"
